<canvas id="game" >

</canvas>

<script>
    const HEIGHT = 400;
    const WIDTH = 400;
    const BACKGROUND_COLOR = 'lightblue';
    const FOREGROUND = "purple";
    const game = document.querySelector('canvas');
    const ctx = initContext();
    const FPS =10;
    
    let dz = 0.5;
    let angle = 0;
    let matrix = [ 
        {x:0.25,y:0.25,z:0.25},
        {x:-0.25,y:0.25,z:0.25},
        {x:-0.25,y:-0.25,z:0.25},
        {x:0.25,y:-0.25,z:0.25},

/*
        {x:0.125,y:0.125,z:0.5},
        {x:-0.125,y:0.125,z:0.5},
        {x:-0.125,y:-0.125,z:0.5},
        {x:0.125,y:-0.125,z:0.5},

        {x:0.125,y:0.125,z:-0.5},
        {x:-0.125,y:0.125,z:-0.5},
        {x:-0.125,y:-0.125,z:-0.5},
        {x:0.125,y:-0.125,z:-0.5},
        */
        
        {x:0.25,y:0.25,z:-0.25},
        {x:-0.25,y:0.25,z:-0.25},
        {x:-0.25,y:-0.25,z:-0.25},
        {x:0.25,y:-0.25,z:-0.25},
    ]

    let faces = [
        [0,1,2,3],
        [4,5,6,7],
        [0,4,5,1],
        [2,6,7,3]
    ]
    main();
    function main(){
        game.height = HEIGHT;
        game.width = WIDTH;
        console.log(ctx);
        refreshFrame();
       // point(screen({x:0.5,y:0}));
        //point(screen(project({x:0.5,y:0,z:0.5})));
        //matrix = matrix.map(vector=>translate_z(vector,6.14));
        setInterval(frame,1000/FPS);
    }
    
    function frame(){
        refreshFrame();

        const dt=1/FPS;
        dz+=1*dt
        angle+=Math.PI*dt;
        /*for(const v of matrix){
            point(screen(project(
                translate_z(rotate_xz(v,angle),dz)
            )))
            
        }*/
        for(face of faces){
            for (let i = 0; i < face.length; ++i) {         
                const a = matrix[face[i]];
                const b = matrix[face[(i+1)%face.length]];
                line(
                    screen(project(
                        translate_z(rotate_xz(a,angle),dz)
                    )),
                    screen(project(
                        translate_z(rotate_xz(b,angle),dz)
                    ))
                )
            }
        }
    }
    function translate_z(v,distance){
        return {
            x : v.x,
            y : v.y,
            z:v.z+distance
        };
    }

    function rotate_xz({x,y,z},angle){
        /*
        x' = x*cosO - y*sinO
        y' = x*sinO + y*cosO
        */
        return{
            x : x*Math.cos(angle) - z*Math.sin(angle),
            y,
            z : x*Math.sin(angle) + z*Math.cos(angle)
        }
    }
    function handleMove(){
         window.addEventListener("keydown",(event)=>{
            const speed = 0.1;
            switch (event.key) {
                case "z":
                    z+=speed;
                    break;

                    case "s":
                        z-=speed;
                    break;
                default:
                    break;
            }
            refreshFrame();
            point(screen(project({x:1,y:1,z:z})));
        })
    }
    function drawRepere(){
        text("1",screen({x :0.95,y:0}))
        text("0",screen({x :0,y:0}))
        text("-1",screen({x :-0.95,y:0}))

        text("1",screen({x :0,y:0.95}))
        text("-1",screen({x :0,y:-0.95}))

    }

    function project({x,y,z}){
        return {
            x : x/z,
            y : y/z
        }
    }
    function text(text="na",{x,y},textWidth=10){
        
        ctx.fillText(text,x,y,textWidth);
    }
    /**
     * Transform point from display(repere cartesien -1..1) 
     * coord to screen(game) coordinates (0..WIDTH)
     * @param {p} {x:number,y:number}
    **/ 
    function screen(p){
        
      return {
        x:(p.x+1)/2*game.width,
        y:(1-(p.y+1)/2)*game.height
      };
    }
    function refreshFrame(){
        clear(ctx);
        drawRepere();
    }
    function clear(ctx){
        const previousFillStyle = ctx.fillStyle;
        ctx.fillStyle = BACKGROUND_COLOR;
        ctx.fillRect(0,0,WIDTH,HEIGHT);
        ctx.fillStyle = previousFillStyle;
    }
    function initContext(){
        game.width = WIDTH;
        game.height = HEIGHT;
        game.style.border = '1px solid black';
        const ctx = game.getContext('2d');
        clear(ctx);
        return ctx;
    }
    function draw(x,y,height=100,width=100,color = FOREGROUND){
        const previousFillStyle = ctx.fillStyle;
        ctx.fillStyle = color;
        ctx.fillRect(x-width/2,y-height/2,width,height);
        ctx.fillStyle = previousFillStyle;
    }
    function point({x,y}){
        draw(x,y,10,10);
    }
    function line(p1,p2){
        ctx.strokeStyle = FOREGROUND;
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(p1.x,p1.y);
        ctx.lineTo(p2.x,p2.y);
        ctx.stroke();
    }
</script>