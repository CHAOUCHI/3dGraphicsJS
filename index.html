<h1>Cube Canvas JS Vanilla</h1>
<ul>
    <li>Z : avancer </li>
    <li>Q : Aller à gauche</li>
    <li>S : reculer</li>
    <li>D : Aller à droite</li>
</ul>
<div>
    <button id="automove">Auto move le cube</button>
    <button id="autorotate">Auto rotate le cube</button>
</div>
<canvas id="game" >

</canvas>


<script>
    const autoMoveButton = document.querySelector("#automove")
    const autoRotateButton = document.querySelector("#autorotate")
    const HEIGHT = 400;
    const WIDTH = 400;
    const BACKGROUND_COLOR = 'lightblue';
    const FOREGROUND = "purple";
    const game = document.querySelector('canvas');
    const ctx = initContext();
    const FPS =60;
    let isAutoMove = false;
    let isAutoRotate = true;
    autoMoveButton.onclick = ()=>isAutoMove=!isAutoMove;
    autoRotateButton.onclick = ()=>isAutoRotate=!isAutoRotate;
    
    
    let dz = 0.6;
    let dx = 0;
    let angle = 0;
    let matrix = [ 
        {x:0.25,y:0.25,z:0.25},
        {x:-0.25,y:0.25,z:0.25},
        {x:-0.25,y:-0.25,z:0.25},
        {x:0.25,y:-0.25,z:0.25},

/*
        {x:0.125,y:0.125,z:0.5},
        {x:-0.125,y:0.125,z:0.5},
        {x:-0.125,y:-0.125,z:0.5},
        {x:0.125,y:-0.125,z:0.5},

        {x:0.125,y:0.125,z:-0.5},
        {x:-0.125,y:0.125,z:-0.5},
        {x:-0.125,y:-0.125,z:-0.5},
        {x:0.125,y:-0.125,z:-0.5},
        */
        
        {x:0.25,y:0.25,z:-0.25},
        {x:-0.25,y:0.25,z:-0.25},
        {x:-0.25,y:-0.25,z:-0.25},
        {x:0.25,y:-0.25,z:-0.25},
    ]

    let faces = [
        [0,1,2,3],
        [4,5,6,7],
        [0,4,5,1],
        [2,6,7,3]
    ]
    main();
    function main(){
        game.height = HEIGHT;
        game.width = WIDTH;
        console.log(ctx);
        refreshFrame();
       // point(screen({x:0.5,y:0}));
        //point(screen(project({x:0.5,y:0,z:0.5})));
        //matrix = matrix.map(vector=>translate_z(vector,6.14));
        handleMove();
        setInterval(frame,1000/FPS);

    }
    
    function frame(){
        refreshFrame();

        const dt=1/FPS;
        if(isAutoMove)
            dz+=1*dt
        if(isAutoRotate)
            angle+=0.1*Math.PI*dt;
        /*for(const v of matrix){
            point(screen(project(
                translate_z(rotate_xz(v,angle),dz)
            )))
            
        }*/
       // Pour chaque face de  mon tableau d'index de points
       // chaque points etant un sommet de mon cube
        for(face of faces){
            // pour chaque sommet d'une face
            for (let i = 0; i < face.length; ++i) {         
                const p1 = matrix[face[i]]; // Premier sommet
                const p2 = matrix[face[(i+1)%face.length]]; // 2eme sommet
                line(
                    screen(project(
                        translate_x(translate_z(rotate_xz(p1,angle),dz),dx)
                    )),
                    screen(project(
                        translate_x(translate_z(rotate_xz(p2,angle),dz),dx)
                    ))
                )
            }
        }
    }
    // deplace un point sur l'axe z (la profondeur)
    function translate_z(v,distance){
        return {
            x : v.x,
            y : v.y,
            z:v.z+distance
        };
    }
     function translate_x(v,distance){
        return {
            x : v.x+distance,
            y : v.y,
            z : v.z
        };
    }

    // Rotation d'un Vector3 autour de l'axe Y donc modification de x et z
    // J'ai juste appliquer la formule prise sur wikipedia :https://fr.wikipedia.org/wiki/Rotation_vectorielle
    function rotate_xz({x,y,z},angle){
        /*
        x' = x*cosO - y*sinO
        y' = x*sinO + y*cosO
        */
        return{
            x : x*Math.cos(angle) - z*Math.sin(angle),
            y,
            z : x*Math.sin(angle) + z*Math.cos(angle)
        }
    }
    // Not used but may serve as a camera
    function handleMove(){
         window.addEventListener("keydown",(event)=>{
            const speed = 0.01;
            switch (event.key) {
                case "z":
                        dz-=speed;
                    break;

                    case "s":
                        dz+=speed;
                    break;
                    case "q":
                        dx+=speed;
                        break;
                        case "d":
                        dx-=speed;
                        break;
                default:
                    break;
            }
        })
    }
    function drawRepere(){
        text("1",screen({x :0.95,y:0}))
        text("0",screen({x :0,y:0}))
        text("-1",screen({x :-0.95,y:0}))

        text("1",screen({x :0,y:0.95}))
        text("-1",screen({x :0,y:-0.95}))

    }

    // transform un Vector3 en Vector2 (fait disparaitre l'axe z en ajoutant de la paralaxe)
    function project({x,y,z}){
        return {
            x : x/z,
            y : y/z
        }
    }
    function text(text="na",{x,y},textWidth=10){
        
        ctx.fillText(text,x,y,textWidth);
    }
    /**
     * Transform point from display(repere cartesien -1..1) 
     * coord to screen(game) coordinates (0..WIDTH)
     * Transform un Vector2 en un Vector2 utilisable par HTML Canvas
     * @param {p} {x:number,y:number}
    **/ 
    function screen(p){
        
      return {
        x:(p.x+1)/2*game.width,
        y:(1-(p.y+1)/2)*game.height
      };
    }
    function refreshFrame(){
        clear(ctx);
        drawRepere();
    }
    function clear(ctx){
        const previousFillStyle = ctx.fillStyle;
        ctx.fillStyle = BACKGROUND_COLOR;
        ctx.fillRect(0,0,WIDTH,HEIGHT);
        ctx.fillStyle = previousFillStyle;
    }
    function initContext(){
        game.width = WIDTH;
        game.height = HEIGHT;
        game.style.border = '1px solid black';
        const ctx = game.getContext('2d');
        clear(ctx);
        return ctx;
    }
    function draw(x,y,height=100,width=100,color = FOREGROUND){
        const previousFillStyle = ctx.fillStyle;
        ctx.fillStyle = color;
        ctx.fillRect(x-width/2,y-height/2,width,height);
        ctx.fillStyle = previousFillStyle;
    }
    function point({x,y}){
        draw(x,y,10,10);
    }
    // Desine une ligne entre deux points
    function line(p1,p2){
        ctx.strokeStyle = FOREGROUND;
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(p1.x,p1.y);
        ctx.lineTo(p2.x,p2.y);
        ctx.stroke();
    }
</script>